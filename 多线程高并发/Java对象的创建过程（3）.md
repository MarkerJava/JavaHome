Java 对象的创建过程的5步（非常重要，建议能默写出来具体每一步做什么）

1、从JVM内存模型聊起

Java 虚拟机在执行 Java 程序的过程中会把它管理的内存划分成若干个不同的数据区域如下。

**线程共享**：

* 堆：是Java 虚拟机所管理内存中最大的一块，在虚拟机启动时创建。堆主要目的就是存放对象实例，所有对象实例以及数组都在这里分配内存。同时也是垃圾收集器管理的主要区域。
* 方法区：方法区主要用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据

**线程私**：

* 程序计数器：主要完成字节码解释器工作时通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等功能都需要依赖这个计数器来完的。（每个线程都有独立的程序计数器）
* 虚拟机栈：在每个方法执行的同时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。
* 本地方法栈：用于存放该本地方法的局部变量表、操作数栈、动态链接、出口信息。方法执行完毕后相应的栈帧也会出栈并释放内存空间。

2、Java对象创建过程

步骤1：类加载检查。首先Java虚拟机遇到new指令，它会先去常量池当中定位类的符号引用，然后检查这个类的符号引用是否被加载或初始化过。

步骤2：类加载检查通过后，如果已经加载过，则虚拟机为对象分配内存；如果没有，则进行类加载的过程。

> 内存分配并发问题：
>
> 在创建对象时，需要考虑的线程安全问题，虚拟机主要采用两种方式来保证线程安全
>
> **CAS+失败重试：** CAS 是乐观锁的一种实现方式。所谓乐观锁就是，每次不加锁而是假设没有冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。**虚拟机采用 CAS 配上失败重试的方式保证更新操作的原子性。
>
> **TLAB：** 为每一个线程预先在Eden区分配一块儿内存，JVM在给线程中的对象分配内存时，首先在TLAB分配，当对象大于TLAB中的剩余内存或TLAB的内存已用尽时，再采用上述的CAS进行内存分配。

步骤3：虚拟机为分配到的内存空间都赋零值，主要为了保证对象的实例字段在 Java 代码中可以不赋初始值就直接使用，程序能访问到这些字段的数据类型所对应的零值。

步骤4： 初始化零值完成之后，虚拟机要对对象进行必要的设置

步骤5：执行 init 方法。在上面工作都完成之后，把对象按照程序员的意愿进行初始化，执行类的初始化函数。当执行完成之后，我们就得到了一个新的对象。

3、String 类和常量池

```java
 String str1 = "abcd";
 String str2 = new String("abcd");
 System.out.println(str1==str2);//false
```

第一种方式是在常量池中拿对象，第二种方式是直接在堆内存空间创建一个新的对象。

4、Java堆溢出问题

Java堆是存储对象实例，只要不断创建对象，并且保证GC Roots到对象之间可达路径来避免垃圾回收机制清除这些对象，如果在对象数量达到堆的容量限制后就会产生 内存溢出异常。