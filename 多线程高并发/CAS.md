面试被问到ABA如何解决？

面试官：小王你简历上说熟悉多线程高并发嘛，那我问你ABA如何解决？

小王：啊？什么是ABA嘛，小王摸了摸头，ABA我还真不知道是什么东西，好像没有听说过。

面试官：那好吧！那我们聊聊CAS，你简单讲一下CAS是什么？

小王：CAS是“比较交换”的，它需要有3个操作就是：内存地址V、旧的预值A和即将要更新的目标值B。

面试官：行吧！那今天面试就到这里吧，你先回去三天左右有通知。

*在Java并发，首先最熟悉的是`synchronized`关键字，但`synchronized`属于重量级锁，很多时候会引起性能的问题。很多人会想到`volatile`也是个不错的选择呀，但大家应该知道`volatile`只保证可见性，而不保证原子性的，只能在某些场合下使用。*

### 什么是CAS

在JDK新增的锁里头，CAS大量的运用，大家有时间可以跟踪源码看看。CAS全称叫compare and swap（比较或者交换），<font color="red">**就是它在没有锁的状态下，可以保证多个线程对一个值的更新。**</font>

例如：多线程一致情况下，A线程去读这个值，这个值原来是个“0”，然后A线程去拿这个值“0”来修改成“1”。最后A线程把修改的“1”返回去的时候，先判断是不是原来的这个值是“0”，如果还是“0”，说明其他线程没有动过这个值，然后A线程直接把修改的值“1”写上去。这样就要考虑别的线程同步问题了，

### 什么是ABA问题

使用CAS会造成ABA问题，一个线程a将数值改成了b，接着又改成了a，此时CAS认为是没有变化，其实是已经变化过了，这种过程就叫ABA问题。

### 如何解决ABA问题

解决ABA问题非常简单，就是使用版本号标识，每当修改操作一次版本号加1，这样比较时候，不管比较值还比较了版本号。但是在java5中，已经提供了AtomicStampedReference来解决问题了。

### CAS缺点

通过以上，大家都知道CAS虽然很高效的解决了原子操作问题，但是CAS仍然存在问题

* 循环时间长，开销很大：就是如果CAS失效，就会一直进行尝试，当时间过长仍然失败，那么就会给CPU带来很大的开销。
* 只能保证一个共享变量的原子操作：当对一个变量执行操作时，可以使用循环 CAS 的方式来保证原子操作，但对多个变量操作时，CAS 目前无法直接保证操作的原子性。可以这样解决：使用互斥锁来保证原子性、将多个变量封装成对象，通过 AtomicReference 来保证原子性。

